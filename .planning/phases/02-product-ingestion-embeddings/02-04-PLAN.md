---
phase: 02-product-ingestion-embeddings
plan: 04
type: execute
depends_on: []
files_modified: [apps/backend/src/features/products/service/woocommerce_client.py, apps/backend/src/features/products/schemas/schemas.py, apps/backend/src/core/config.py]
domain: backend
---

<objective>
Implement WooCommerce API client for fetching products from partner stores.

Purpose: Enable product catalog ingestion from WooCommerce-powered stores with proper authentication and pagination.
Output: WooCommerceClient class with async product fetching, rate limit handling, and data transformation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@apps/backend/src/core/config.py
@apps/backend/src/features/storage/service/service.py

**Tech stack available:** httpx (async HTTP), Pydantic
**WooCommerce API requirements:**
- REST API v3 (wc/v3 endpoint)
- Basic Auth with consumer key/secret
- HTTPS required
- Pagination via page/per_page parameters
- Rate limiting is optional/disabled by default on most stores
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WooCommerce client service</name>
  <files>apps/backend/src/features/products/__init__.py, apps/backend/src/features/products/service/__init__.py, apps/backend/src/features/products/service/woocommerce_client.py, apps/backend/src/core/config.py</files>
  <action>
Create features/products/ directory structure.

Add to config.py (as optional settings for partner stores):
```python
# WooCommerce partner store (optional - for future partner integration)
woo_store_url: str | None = None
woo_consumer_key: str | None = None
woo_consumer_secret: str | None = None
```

Create WooCommerceClient in woocommerce_client.py:

```python
import httpx
from dataclasses import dataclass
from typing import AsyncIterator
import base64

@dataclass
class WooProduct:
    """Raw product data from WooCommerce API"""
    id: int
    name: str
    description: str
    price: str  # WooCommerce returns price as string
    regular_price: str
    sale_price: str
    images: list[dict]  # [{"src": "url", "alt": "..."}]
    permalink: str
    status: str
    stock_status: str
    categories: list[dict]

class WooCommerceClient:
    def __init__(
        self,
        store_url: str,
        consumer_key: str,
        consumer_secret: str,
        timeout: float = 30.0
    ):
        self.store_url = store_url.rstrip('/')
        self.api_url = f"{self.store_url}/wp-json/wc/v3"
        self._auth = (consumer_key, consumer_secret)
        self.timeout = timeout

    async def get_products(
        self,
        page: int = 1,
        per_page: int = 100,
        status: str = "publish",
        stock_status: str = "instock"
    ) -> list[WooProduct]:
        """Fetch products from WooCommerce store."""
        async with httpx.AsyncClient(timeout=self.timeout) as client:
            response = await client.get(
                f"{self.api_url}/products",
                auth=self._auth,
                params={
                    "page": page,
                    "per_page": per_page,
                    "status": status,
                    "stock_status": stock_status
                }
            )
            response.raise_for_status()

            products = []
            for item in response.json():
                products.append(WooProduct(
                    id=item["id"],
                    name=item["name"],
                    description=item.get("description", ""),
                    price=item.get("price", "0"),
                    regular_price=item.get("regular_price", "0"),
                    sale_price=item.get("sale_price", ""),
                    images=item.get("images", []),
                    permalink=item.get("permalink", ""),
                    status=item.get("status", ""),
                    stock_status=item.get("stock_status", "")
                ))
            return products

    async def get_all_products(
        self,
        per_page: int = 100,
        max_pages: int | None = None
    ) -> AsyncIterator[WooProduct]:
        """Iterate through all products with pagination."""
        page = 1
        while True:
            if max_pages and page > max_pages:
                break

            products = await self.get_products(page=page, per_page=per_page)
            if not products:
                break

            for product in products:
                yield product

            if len(products) < per_page:
                break

            page += 1

    async def get_product_count(self) -> int:
        """Get total number of products."""
        async with httpx.AsyncClient(timeout=self.timeout) as client:
            response = await client.get(
                f"{self.api_url}/products",
                auth=self._auth,
                params={"per_page": 1, "status": "publish"}
            )
            response.raise_for_status()
            # WooCommerce returns total count in header
            return int(response.headers.get("X-WP-Total", 0))

    async def health_check(self) -> bool:
        """Check if store is accessible."""
        try:
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.get(
                    f"{self.api_url}/products",
                    auth=self._auth,
                    params={"per_page": 1}
                )
                return response.status_code == 200
        except Exception:
            return False
```
  </action>
  <verify>cd apps/backend && python -c "from src.features.products.service.woocommerce_client import WooCommerceClient, WooProduct; print('WooCommerce client OK')"</verify>
  <done>WooCommerceClient created with auth, pagination, and product fetching</done>
</task>

<task type="auto">
  <name>Task 2: Create product transformation and schemas</name>
  <files>apps/backend/src/features/products/schemas/__init__.py, apps/backend/src/features/products/schemas/schemas.py, apps/backend/src/features/products/service/transformer.py</files>
  <action>
Create schemas for product data:

```python
from pydantic import BaseModel, Field
from decimal import Decimal
from datetime import datetime
from uuid import UUID

class ProductCreate(BaseModel):
    """Data needed to create a product in our system"""
    external_id: str
    store_id: str
    title: str
    description: str | None = None
    price: Decimal
    currency: str = "USD"
    image_url: str
    product_url: str

class ProductResponse(BaseModel):
    """Product data returned by API"""
    id: UUID
    external_id: str
    store_id: str
    title: str
    description: str | None
    price: Decimal
    currency: str
    image_url: str
    product_url: str
    created_at: datetime
    updated_at: datetime

class ProductSyncStatus(BaseModel):
    """Status of product sync operation"""
    store_id: str
    total_fetched: int
    total_valid: int
    total_rejected: int
    rejection_reasons: dict[str, int] = Field(default_factory=dict)
```

Create transformer.py to convert WooProduct to ProductCreate:

```python
from decimal import Decimal, InvalidOperation
from .woocommerce_client import WooProduct
from ..schemas.schemas import ProductCreate

class ProductTransformer:
    def __init__(self, store_id: str, default_currency: str = "USD"):
        self.store_id = store_id
        self.default_currency = default_currency

    def transform(self, woo_product: WooProduct) -> ProductCreate | None:
        """Transform WooCommerce product to our format. Returns None if invalid."""
        # Skip products without images
        if not woo_product.images:
            return None

        # Parse price
        try:
            price = Decimal(woo_product.price) if woo_product.price else Decimal("0")
            if price <= 0:
                return None
        except InvalidOperation:
            return None

        # Get first image URL
        image_url = woo_product.images[0].get("src", "")
        if not image_url:
            return None

        return ProductCreate(
            external_id=str(woo_product.id),
            store_id=self.store_id,
            title=woo_product.name,
            description=woo_product.description[:1000] if woo_product.description else None,
            price=price,
            currency=self.default_currency,
            image_url=image_url,
            product_url=woo_product.permalink
        )
```
  </action>
  <verify>cd apps/backend && python -c "from src.features.products.schemas import ProductCreate, ProductResponse; from src.features.products.service.transformer import ProductTransformer; print('Transformer OK')"</verify>
  <done>Product schemas and transformer created for WooCommerce to internal format conversion</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] WooCommerceClient can be instantiated with credentials
- [ ] ProductTransformer converts WooProduct to ProductCreate
- [ ] Invalid products (no image, no price) are filtered out
- [ ] All schemas validate correctly
</verification>

<success_criteria>

- WooCommerce client handles Basic Auth correctly
- Pagination iterates through all products
- Product transformation filters invalid products
- Data types match our Product model requirements
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-ingestion-embeddings/02-04-SUMMARY.md`
</output>
