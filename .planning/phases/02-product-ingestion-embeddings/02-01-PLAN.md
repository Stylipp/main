---
phase: 02-product-ingestion-embeddings
plan: 01
type: execute
depends_on: []
files_modified: [apps/backend/src/models/product.py, apps/backend/alembic/versions/*_add_product_model.py, apps/backend/src/core/qdrant.py, apps/backend/src/core/config.py]
domain: backend
---

<objective>
Set up Product model in PostgreSQL and Qdrant collection for 768-dimensional FashionSigLIP embeddings.

Purpose: Establish the data layer for product metadata (PostgreSQL) and vector embeddings (Qdrant) as single source of truth.
Output: Product SQLAlchemy model with migration, Qdrant collection configured for cosine similarity search.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md
@apps/backend/src/models/base.py
@apps/backend/src/core/config.py
@apps/backend/src/core/database.py

**Tech stack available:** PostgreSQL 16, Qdrant v1.7.4, SQLAlchemy 2.0 async, Alembic
**Established patterns:** Feature folder convention, async database sessions, Alembic migrations
**Constraining decisions:**
- [01-04]: Alembic manages all DB schema (no init.sql)
- [01-04]: uuid-ossp extension needs Alembic migration when first UUID column added
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Product model with Alembic migration</name>
  <files>apps/backend/src/models/product.py, apps/backend/src/models/__init__.py, apps/backend/alembic/versions/*_add_product_model.py</files>
  <action>
Create Product SQLAlchemy model with fields:
- id: UUID primary key (use uuid-ossp extension)
- external_id: String (WooCommerce product ID, indexed)
- store_id: String (identifies source store, indexed)
- title: String (product name)
- description: Text (optional)
- price: Decimal(10,2)
- currency: String(3) default 'USD'
- image_url: String (original product image URL)
- product_url: String (affiliate link to product page)
- created_at: DateTime with timezone
- updated_at: DateTime with timezone

Create Alembic migration that:
1. Creates uuid-ossp extension (op.execute('CREATE EXTENSION IF NOT EXISTS "uuid-ossp"'))
2. Creates products table with all fields
3. Adds indexes on external_id, store_id, created_at

Export Product from models/__init__.py for Alembic discovery.
  </action>
  <verify>cd apps/backend && alembic upgrade head && alembic check</verify>
  <done>Product table exists in PostgreSQL with all fields and indexes, migration is reversible</done>
</task>

<task type="auto">
  <name>Task 2: Create Qdrant client and collection setup</name>
  <files>apps/backend/src/core/qdrant.py, apps/backend/src/core/config.py, apps/backend/pyproject.toml</files>
  <action>
Add qdrant-client dependency to pyproject.toml.

Add Qdrant settings to config.py:
- qdrant_host: str = "localhost"
- qdrant_port: int = 6333
- qdrant_collection: str = "products"

Create apps/backend/src/core/qdrant.py with:
1. AsyncQdrantClient initialization function
2. Collection creation function that creates "products" collection with:
   - vectors_config: VectorParams(size=768, distance=Distance.COSINE)
   - on_disk_payload: True (for large payloads)
3. Payload schema: product_id (UUID as string), store_id, price, created_at
4. Health check function that verifies collection exists

The collection should be created idempotently (check if exists first).

Use qdrant_client.models for VectorParams, Distance, PointStruct.
  </action>
  <verify>cd apps/backend && python -c "from src.core.qdrant import get_qdrant_client, ensure_collection; import asyncio; asyncio.run(ensure_collection())"</verify>
  <done>Qdrant client configured, products collection created with 768-dim cosine vectors, health check passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/backend && alembic upgrade head` succeeds
- [ ] Product table exists with correct columns and indexes
- [ ] Qdrant products collection exists with 768-dim vectors
- [ ] `alembic downgrade -1 && alembic upgrade head` works (migration reversible)
</verification>

<success_criteria>

- Product model created with all required fields
- Alembic migration applies cleanly
- uuid-ossp extension enabled in PostgreSQL
- Qdrant collection configured for 768-dim cosine similarity
- Both stores ready for product ingestion
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-ingestion-embeddings/02-01-SUMMARY.md`
</output>
