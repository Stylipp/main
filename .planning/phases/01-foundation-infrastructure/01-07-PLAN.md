---
phase: 01-foundation-infrastructure
plan: 07
type: execute
depends_on: ["01-02", "01-03", "01-04"]
files_modified: [infra/docker-compose.yml, infra/docker-compose.dev.yml, infra/docker-compose.prod.yml, infra/traefik/traefik.yml, infra/traefik/dynamic.yml]
---

<objective>
Configure Traefik reverse proxy with split Docker Compose configs (base, dev, prod) for routing services through Cloudflare Tunnel.

Purpose: Establish reverse proxy layer with environment separation. docker-compose.yml contains base services, docker-compose.dev.yml adds exposed ports for local development, docker-compose.prod.yml adds Traefik routing for production. Cloudflare Tunnel forwards to Traefik in production.
Output: Three Docker Compose files ready for dev (docker compose -f docker-compose.yml -f docker-compose.dev.yml up) and prod (docker compose -f docker-compose.yml -f docker-compose.prod.yml up).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md

**Domain**: stylipp.com
**Cloudflare Tunnel**: Already configured on server (david@173.249.48.168:62222)
**Routing plan**:
- stylipp.com → apps/web (React PWA)
- api.stylipp.com → apps/backend (FastAPI)
- qdrant.stylipp.com → Qdrant dashboard (optional, for admin)

**Traefik role**: Internal reverse proxy, Cloudflare Tunnel forwards to Traefik, Traefik routes to services
**HTTPS**: Handled by Cloudflare Tunnel (traffic arrives at Traefik as HTTP)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create base docker-compose.yml with database services</name>
  <files>infra/docker-compose.yml, infra/docker-compose.dev.yml, infra/docker-compose.prod.yml</files>
  <action>
    **IMPORTANT:** For MVP, create single docker-compose.yml with both dev and prod concerns. In production, split into:
    - docker-compose.yml (base: services only, no ports)
    - docker-compose.dev.yml (override: add ports 5432, 6333, 6379)
    - docker-compose.prod.yml (override: add Traefik with routing labels)

    For now, create unified infra/docker-compose.yml with Traefik:

    **traefik service:**
    - image: traefik:v3.0
    - ports: "80:80" (HTTP entrypoint - Cloudflare Tunnel connects here)
    - volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro (for Docker provider)
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    - labels:
      - traefik.enable=true
    - restart: unless-stopped
    - networks:
      - traefik_network (create shared network for all services)

    Create infra/traefik/traefik.yml (static configuration):
    - entryPoints:
      - web: address: ":80"
    - providers:
      - docker:
          endpoint: "unix:///var/run/docker.sock"
          exposedByDefault: false
          network: traefik_network
      - file:
          filename: /etc/traefik/dynamic.yml
    - log:
        level: INFO
    - accessLog: {} (enable access logging)

    Define traefik_network in networks section (external: false)
    Add all services (postgres, qdrant, redis) to traefik_network
  </action>
  <verify>docker-compose config validates, traefik service defined with Docker socket mount and port 80 exposed</verify>
  <done>Traefik service added to docker-compose.yml with static configuration, shared network created for service communication</done>
</task>

<task type="auto">
  <name>Task 2: Configure Docker labels for service routing</name>
  <files>infra/docker-compose.yml</files>
  <action>
    Update infra/docker-compose.yml to add services with Traefik labels:

    **Add web service (React PWA):**
    - build: ../apps/web (will create Dockerfile in later phase)
    - For now, use placeholder: image: nginx:alpine with volume mount to apps/web/dist
    - labels:
      - traefik.enable=true
      - traefik.http.routers.web.rule=Host(`stylipp.com`) || Host(`www.stylipp.com`)
      - traefik.http.routers.web.entrypoints=web
      - traefik.http.services.web.loadbalancer.server.port=80
    - networks: traefik_network

    **Add backend service (FastAPI):**
    - build: ../apps/backend (will create Dockerfile in later phase)
    - For now, use placeholder comment (will be added when Dockerfile ready)
    - labels:
      - traefik.enable=true
      - traefik.http.routers.backend.rule=Host(`api.stylipp.com`)
      - traefik.http.routers.backend.entrypoints=web
      - traefik.http.services.backend.loadbalancer.server.port=8000
    - environment: Import from .env (DATABASE_URL, etc.)
    - depends_on: postgres, qdrant, redis
    - networks: traefik_network

    **Update qdrant service (optional admin access):**
    - Add labels:
      - traefik.enable=true
      - traefik.http.routers.qdrant.rule=Host(`qdrant.stylipp.com`)
      - traefik.http.routers.qdrant.entrypoints=web
      - traefik.http.services.qdrant.loadbalancer.server.port=6333
    - networks: traefik_network
  </action>
  <verify>docker-compose config shows web, backend, qdrant services with traefik labels for Host rules</verify>
  <done>Services configured with Traefik labels for routing: stylipp.com → web, api.stylipp.com → backend, qdrant.stylipp.com → qdrant</done>
</task>

<task type="auto">
  <name>Task 3: Create dynamic configuration and verify routing</name>
  <files>infra/traefik/dynamic.yml</files>
  <action>
    Create infra/traefik/dynamic.yml (dynamic configuration):
    - http:
        middlewares:
          cors:
            headers:
              accessControlAllowOriginList: ["https://stylipp.com", "http://localhost:5173"]
              accessControlAllowMethods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
              accessControlAllowHeaders: ["*"]
              accessControlMaxAge: 86400

    Add middleware to backend router in docker-compose.yml:
    - traefik.http.routers.backend.middlewares=cors@file

    Add note about Cloudflare Tunnel configuration:
    "Cloudflare Tunnel should forward traffic to http://localhost:80 (Traefik entrypoint)"
    "Configure in Cloudflare dashboard: stylipp.com → http://localhost:80"

    Test routing (after docker-compose up):
    - curl -H "Host: stylipp.com" http://localhost (should route to web)
    - curl -H "Host: api.stylipp.com" http://localhost/health (should route to backend)
  </action>
  <verify>traefik/dynamic.yml exists with CORS middleware, docker-compose config validates with middleware reference</verify>
  <done>Dynamic Traefik configuration created with CORS middleware, routing rules verified, ready for Cloudflare Tunnel connection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `docker-compose -f infra/docker-compose.yml config` validates successfully
- [ ] Traefik service defined with port 80 and Docker socket mount
- [ ] Web service has Host(`stylipp.com`) routing rule
- [ ] Backend service has Host(`api.stylipp.com`) routing rule
- [ ] Qdrant service has Host(`qdrant.stylipp.com`) routing rule
- [ ] CORS middleware configured for backend
- [ ] traefik_network shared by all services
- [ ] traefik/traefik.yml and traefik/dynamic.yml exist
</verification>

<success_criteria>

- Traefik running in Docker with Docker provider
- Host-based routing configured for 3 subdomains
- CORS middleware applied to backend API
- Services connected via shared Docker network
- Routing testable with curl -H "Host: ..." http://localhost
- Ready to receive traffic from Cloudflare Tunnel
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-07-SUMMARY.md`:

# Phase 1 Plan 7: Traefik Configuration Summary

**Configured Traefik reverse proxy with Docker labels for routing through existing Cloudflare Tunnel**

## Accomplishments

- Added Traefik service to Docker Compose
- Configured host-based routing for stylipp.com, api.stylipp.com, qdrant.stylipp.com
- Created CORS middleware for backend API
- Set up shared Docker network for service communication
- Defined static and dynamic Traefik configuration

## Files Created/Modified

- `infra/docker-compose.yml` - Added Traefik service and routing labels for web, backend, qdrant
- `infra/traefik/traefik.yml` - Static configuration with Docker provider
- `infra/traefik/dynamic.yml` - Dynamic configuration with CORS middleware

## Decisions Made

- Traefik v3.0 for latest features and performance
- Host-based routing (not path-based) for clean subdomain structure
- CORS middleware for cross-origin requests from frontend
- HTTP-only entrypoint (HTTPS handled by Cloudflare Tunnel)
- Docker socket for automatic service discovery

## Issues Encountered

None (Cloudflare Tunnel already configured, just needs to point to localhost:80)

## Next Step

Ready for 01-08-PLAN.md (CI/CD & Git Hooks)

**Note**: Configure Cloudflare Tunnel to forward:
- stylipp.com → http://localhost:80
- api.stylipp.com → http://localhost:80
- qdrant.stylipp.com → http://localhost:80

Traefik will handle internal routing based on Host headers.
</output>
