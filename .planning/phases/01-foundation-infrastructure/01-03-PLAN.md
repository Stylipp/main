---
phase: 01-foundation-infrastructure
plan: 03
type: execute
depends_on: ["01-01"]
files_modified: [packages/schemas/pyproject.toml, packages/schemas/stylipp_schemas/__init__.py, packages/schemas/stylipp_schemas/common.py, packages/schemas/stylipp_schemas/user.py, apps/backend/pyproject.toml, apps/backend/src/main.py, apps/backend/src/core/config.py, apps/backend/src/core/__init__.py, apps/backend/alembic.ini, apps/backend/alembic/env.py, apps/backend/src/models/base.py, apps/backend/src/core/database.py]
---

<objective>
Create packages/schemas (Pydantic API contracts) and bootstrap FastAPI backend with feature folder convention, SQLAlchemy 2.0 async, and Alembic migrations for Stylipp.

Purpose: Establish the shared schemas package as single source of truth for API contracts (Pydantic models), then set up the backend API foundation that imports from schemas. This creates clear separation between API contracts (schemas) and database models (SQLAlchemy).
Output: Working packages/schemas Python package, FastAPI server at localhost:8000 with /docs endpoint (OpenAPI spec), database connection ready, and migration system configured.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md

**Backend stack**: FastAPI + Python 3.12+ + SQLAlchemy 2.0 async
**Database**: PostgreSQL (will be configured in Docker plan)
**Migration tool**: Alembic
**Feature folder convention**: Each feature lives under src/features (e.g., features/ai/router/router.py, not ai/router.py)
**Backend separation**: router.py (HTTP), service.py (business logic), repository.py (DB), schemas.py (validation), utils.py (pure functions)
**Schemas package**: packages/schemas with Pydantic models (single source of truth for API contracts)
**Type flow**: packages/schemas (Pydantic) → backend imports → OpenAPI generated → frontend TypeScript
**Port**: 8000 (localhost development, api.stylipp.com production)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create packages/schemas Python package</name>
  <files>packages/schemas/pyproject.toml, packages/schemas/stylipp_schemas/__init__.py, packages/schemas/stylipp_schemas/common.py, packages/schemas/stylipp_schemas/user.py</files>
  <action>
    Create packages/schemas/ directory as a pip-installable Python package.

    Create packages/schemas/pyproject.toml:
    - name: "stylipp-schemas"
    - version: "0.1.0"
    - dependencies: pydantic>=2.0
    - [build-system] with hatchling or setuptools

    Create packages/schemas/stylipp_schemas/__init__.py:
    - Export all schemas for easy imports
    - from .common import *
    - from .user import *

    Create packages/schemas/stylipp_schemas/common.py:
    - BaseResponse(BaseModel): success: bool, message: str | None
    - ErrorResponse(BaseModel): detail: str, code: str | None
    - PaginatedResponse(BaseModel, Generic[T]): items: list[T], total: int, page: int, page_size: int

    Create packages/schemas/stylipp_schemas/user.py:
    - UserCreate(BaseModel): email: EmailStr, password: str
    - UserResponse(BaseModel): id: UUID, email: EmailStr, created_at: datetime
    - UserLogin(BaseModel): email: EmailStr, password: str
    - TokenResponse(BaseModel): access_token: str, token_type: str = "bearer"

    Test: `cd packages/schemas && pip install -e .` (editable install)
  </action>
  <verify>pip install -e packages/schemas succeeds, python -c "from stylipp_schemas import UserResponse" works</verify>
  <done>packages/schemas created with Pydantic models for common and user schemas, pip-installable</done>
</task>

<task type="auto">
  <name>Task 2: Create FastAPI project with pyproject.toml and src/ structure</name>
  <files>apps/backend/pyproject.toml, apps/backend/src/main.py, apps/backend/src/core/config.py, apps/backend/src/core/__init__.py, apps/backend/src/__init__.py</files>
  <action>
    Create apps/backend/ directory with proper Python package structure:

    Create apps/backend/pyproject.toml with dependencies:
    - stylipp-schemas @ file:../../packages/schemas (local dependency)
    - fastapi[all] (includes uvicorn)
    - sqlalchemy[asyncio] ~=2.0
    - asyncpg (PostgreSQL async driver)
    - alembic ~=1.13
    - pydantic-settings
    - python-jose[cryptography] (for JWT)
    - passlib[bcrypt]
    - python-multipart
    - aiofiles
    - [project.optional-dependencies]: ruff, black, pytest, pytest-asyncio

    Create apps/backend/src/ directory for application code (proper Python package structure)

    Create apps/backend/src/main.py:
    - FastAPI app initialization with title "Stylipp API", version "1.0.0"
    - CORS middleware allowing frontend origin (localhost:5173, stylipp.com)
    - Health check endpoint: GET /health returns {"status": "healthy"}
    - Include placeholder for feature routers

    Create apps/backend/src/core/config.py:
    - Pydantic BaseSettings for environment variables
    - DATABASE_URL, SECRET_KEY, DEBUG mode, CORS_ORIGINS

    Add apps/backend/src/__init__.py (empty, makes it a package)
    Add apps/backend/src/core/__init__.py (empty, makes it a package)

    Install dependencies: `cd apps/backend && pip install -e .` (or poetry install)
  </action>
  <verify>cd apps/backend && uvicorn src.main:app --reload starts server at localhost:8000, /docs shows Swagger UI with /health endpoint</verify>
  <done>FastAPI project created with src/ structure, dependencies including dev tools (ruff, black, pytest) installed, server runs with /health and /docs endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Configure SQLAlchemy 2.0 async with base model</name>
  <files>apps/backend/src/core/database.py, apps/backend/src/models/__init__.py, apps/backend/src/models/base.py</files>
  <action>
    Create apps/backend/src/core/database.py:
    - Import create_async_engine, async_sessionmaker from sqlalchemy.ext.asyncio
    - Create async engine with DATABASE_URL from core.config (postgresql+asyncpg://...)
    - Create AsyncSession factory with expire_on_commit=False
    - Add get_db() async generator for dependency injection

    Create apps/backend/src/models/base.py:
    - Import DeclarativeBase from sqlalchemy.orm
    - Define Base class extending DeclarativeBase
    - Add common columns: id (UUID primary key), created_at, updated_at (using func.now())

    Create apps/backend/src/models/__init__.py:
    - Import Base from .base
    - This will be used by Alembic for auto-generating migrations

    Note: Database connection will fail until Docker Compose creates PostgreSQL (next plan). This just sets up the structure.
  </action>
  <verify>No syntax errors in src/core/database.py and src/models/base.py; imports resolve correctly</verify>
  <done>SQLAlchemy 2.0 async configured with engine and session factory in src/, Base model with common columns created</done>
</task>

<task type="auto">
  <name>Task 4: Set up Alembic for database migrations</name>
  <files>apps/backend/alembic.ini, apps/backend/alembic/env.py, apps/backend/alembic/versions/.gitkeep, apps/backend/alembic/script.py.mako</files>
  <action>
    Initialize Alembic: `cd apps/backend && alembic init alembic`

    Modify apps/backend/alembic/env.py:
    - Import Base from src.models (note src/ prefix)
    - Set target_metadata = Base.metadata
    - Configure run_migrations_online() to use async engine
    - Add import path sys.path.insert for apps/backend if needed

    Modify apps/backend/alembic.ini:
    - Set sqlalchemy.url to use core.config.DATABASE_URL (or comment out, will be set via env.py)
    - Configure file_template for migration naming: %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

    Create .gitkeep in alembic/versions/ to track directory

    Test Alembic configuration: `cd apps/backend && alembic check` (will show no database connection until Docker, but should validate config)
  </action>
  <verify>alembic/env.py imports Base from src.models successfully, alembic.ini exists with file_template configured, alembic check shows config valid (connection error expected)</verify>
  <done>Alembic initialized with async support, env.py imports Base from src.models, migration file template configured</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e packages/schemas` succeeds
- [ ] `python -c "from stylipp_schemas import UserResponse, ErrorResponse"` works
- [ ] `cd apps/backend && pip install -e .` installs with stylipp-schemas dependency
- [ ] `cd apps/backend && uvicorn src.main:app --reload` starts server (note src. prefix)
- [ ] Visit http://localhost:8000/docs shows Swagger UI with schemas from stylipp_schemas
- [ ] GET http://localhost:8000/health returns {"status": "healthy"}
- [ ] apps/backend/src/core/database.py has async engine and session factory
- [ ] apps/backend/src/models/base.py has Base class with id, created_at, updated_at
- [ ] Alembic initialized with alembic/env.py configured for async and imports from src.models
- [ ] ruff, black, pytest in dev dependencies
</verification>

<success_criteria>

- packages/schemas installed with Pydantic models (UserResponse, ErrorResponse, etc.)
- FastAPI server runs with /health and /docs endpoints
- Backend imports schemas from stylipp_schemas package
- OpenAPI spec at /openapi.json includes all Pydantic models (for frontend type generation)
- SQLAlchemy 2.0 async configured (will connect when Docker adds PostgreSQL)
- Alembic migration system ready with Base metadata import
- CORS configured for frontend origins
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`:

# Phase 1 Plan 3: Schemas Package & Backend Bootstrap Summary

**Created packages/schemas (Pydantic API contracts) and bootstrapped FastAPI backend with SQLAlchemy 2.0 async**

## Accomplishments

- Created packages/schemas as single source of truth for API contracts
- Created FastAPI project with dependency on stylipp-schemas
- Configured SQLAlchemy 2.0 async engine with Base model (separate from Pydantic schemas)
- Set up Alembic for database migrations with async support
- Created health check endpoint and Swagger docs at /docs with OpenAPI spec

## Files Created/Modified

- `packages/schemas/pyproject.toml` - Schemas package config
- `packages/schemas/stylipp_schemas/*.py` - Pydantic models (UserResponse, ErrorResponse, etc.)
- `apps/backend/pyproject.toml` - Python dependencies (imports stylipp-schemas)
- `apps/backend/src/main.py` - FastAPI app with /health endpoint
- `apps/backend/src/core/config.py` - Environment configuration
- `apps/backend/src/core/database.py` - SQLAlchemy async engine and session
- `apps/backend/src/models/base.py` - SQLAlchemy Base model with common columns
- `apps/backend/alembic.ini` - Alembic configuration
- `apps/backend/alembic/env.py` - Alembic async migrations

## Decisions Made

- packages/schemas contains Pydantic models only (API contracts, single source of truth)
- SQLAlchemy models separate in apps/backend/src/models/ (database layer)
- Backend imports from stylipp_schemas for all request/response types
- OpenAPI spec generated automatically, frontend will use it for TypeScript generation
- UUID primary keys for distributed system safety

## Issues Encountered

None (database connection will be established in Docker plan)

## Next Step

Ready for 01-04-PLAN.md (Docker Infrastructure)
</output>
