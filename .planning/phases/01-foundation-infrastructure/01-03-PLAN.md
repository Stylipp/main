---
phase: 01-foundation-infrastructure
plan: 03
type: execute
depends_on: ["01-01"]
files_modified: [apps/backend/pyproject.toml, apps/backend/src/main.py, apps/backend/src/config.py, apps/backend/alembic.ini, apps/backend/alembic/env.py, apps/backend/src/models/base.py, apps/backend/src/database.py]
---

<objective>
Bootstrap FastAPI backend with feature folder convention, SQLAlchemy 2.0 async, and Alembic migrations for Stylipp.

Purpose: Establish the backend API foundation with async database patterns, migration tooling, and project structure that supports the feature folder convention (ai/router/router.py pattern). This sets up the development environment for all backend services.
Output: Working FastAPI server at localhost:8000 with /docs endpoint, database connection ready, and migration system configured.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md

**Backend stack**: FastAPI + Python 3.12+ + SQLAlchemy 2.0 async
**Database**: PostgreSQL (will be configured in Docker plan)
**Migration tool**: Alembic
**Feature folder convention**: Each feature has subfolders (e.g., ai/router/router.py, not ai/router.py)
**Backend separation**: router.py (HTTP), service.py (business logic), repository.py (DB), schemas.py (validation), utils.py (pure functions)
**Port**: 8000 (localhost development, api.stylipp.com production)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FastAPI project with pyproject.toml and src/ structure</name>
  <files>apps/backend/pyproject.toml, apps/backend/src/main.py, apps/backend/src/config.py, apps/backend/src/__init__.py</files>
  <action>
    Create apps/backend/ directory with proper Python package structure:

    Create apps/backend/pyproject.toml with dependencies:
    - fastapi[all] (includes uvicorn)
    - sqlalchemy[asyncio] ~=2.0
    - asyncpg (PostgreSQL async driver)
    - alembic ~=1.13
    - pydantic ~=2.0
    - pydantic-settings
    - python-jose[cryptography] (for JWT)
    - passlib[bcrypt]
    - python-multipart
    - aiofiles
    - [tool.poetry.group.dev.dependencies] or [project.optional-dependencies]: ruff, black, pytest, pytest-asyncio

    Create apps/backend/src/ directory for application code (proper Python package structure)

    Create apps/backend/src/main.py:
    - FastAPI app initialization with title "Stylipp API", version "1.0.0"
    - CORS middleware allowing frontend origin (localhost:5173, stylipp.com)
    - Health check endpoint: GET /health returns {"status": "healthy"}
    - Include placeholder for feature routers

    Create apps/backend/src/config.py:
    - Pydantic BaseSettings for environment variables
    - DATABASE_URL, SECRET_KEY, DEBUG mode, CORS_ORIGINS

    Add apps/backend/src/__init__.py (empty, makes it a package)

    Install dependencies: `cd apps/backend && pip install -e .` (or poetry install)
  </action>
  <verify>cd apps/backend && uvicorn src.main:app --reload starts server at localhost:8000, /docs shows Swagger UI with /health endpoint</verify>
  <done>FastAPI project created with src/ structure, dependencies including dev tools (ruff, black, pytest) installed, server runs with /health and /docs endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Configure SQLAlchemy 2.0 async with base model</name>
  <files>apps/backend/src/database.py, apps/backend/src/models/__init__.py, apps/backend/src/models/base.py</files>
  <action>
    Create apps/backend/src/database.py:
    - Import create_async_engine, async_sessionmaker from sqlalchemy.ext.asyncio
    - Create async engine with DATABASE_URL from config (postgresql+asyncpg://...)
    - Create AsyncSession factory with expire_on_commit=False
    - Add get_db() async generator for dependency injection

    Create apps/backend/src/models/base.py:
    - Import DeclarativeBase from sqlalchemy.orm
    - Define Base class extending DeclarativeBase
    - Add common columns: id (UUID primary key), created_at, updated_at (using func.now())

    Create apps/backend/src/models/__init__.py:
    - Import Base from .base
    - This will be used by Alembic for auto-generating migrations

    Note: Database connection will fail until Docker Compose creates PostgreSQL (next plan). This just sets up the structure.
  </action>
  <verify>No syntax errors in src/database.py and src/models/base.py; imports resolve correctly</verify>
  <done>SQLAlchemy 2.0 async configured with engine and session factory in src/, Base model with common columns created</done>
</task>

<task type="auto">
  <name>Task 3: Set up Alembic for database migrations</name>
  <files>apps/backend/alembic.ini, apps/backend/alembic/env.py, apps/backend/alembic/versions/.gitkeep, apps/backend/alembic/script.py.mako</files>
  <action>
    Initialize Alembic: `cd apps/backend && alembic init alembic`

    Modify apps/backend/alembic/env.py:
    - Import Base from src.models (note src/ prefix)
    - Set target_metadata = Base.metadata
    - Configure run_migrations_online() to use async engine
    - Add import path sys.path.insert for apps/backend if needed

    Modify apps/backend/alembic.ini:
    - Set sqlalchemy.url to use config.DATABASE_URL (or comment out, will be set via env.py)
    - Configure file_template for migration naming: %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

    Create .gitkeep in alembic/versions/ to track directory

    Test Alembic configuration: `cd apps/backend && alembic check` (will show no database connection until Docker, but should validate config)
  </action>
  <verify>alembic/env.py imports Base from src.models successfully, alembic.ini exists with file_template configured, alembic check shows config valid (connection error expected)</verify>
  <done>Alembic initialized with async support, env.py imports Base from src.models, migration file template configured</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/backend && uvicorn src.main:app --reload` starts server (note src. prefix)
- [ ] Visit http://localhost:8000/docs shows Swagger UI
- [ ] GET http://localhost:8000/health returns {"status": "healthy"}
- [ ] apps/backend/src/database.py has async engine and session factory
- [ ] apps/backend/src/models/base.py has Base class with id, created_at, updated_at
- [ ] Alembic initialized with alembic/env.py configured for async and imports from src.models
- [ ] ruff, black, pytest in dev dependencies
- [ ] No Python syntax errors (`cd apps/backend && python -m py_compile src/main.py src/config.py src/database.py`)
</verification>

<success_criteria>

- FastAPI server runs with /health and /docs endpoints
- SQLAlchemy 2.0 async configured (will connect when Docker adds PostgreSQL)
- Alembic migration system ready with Base metadata import
- CORS configured for frontend origins
- Feature folder structure prepared
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`:

# Phase 1 Plan 3: Backend Bootstrap Summary

**Bootstrapped FastAPI backend with SQLAlchemy 2.0 async and Alembic migrations using feature folder convention**

## Accomplishments

- Created FastAPI project with dependency management and CORS
- Configured SQLAlchemy 2.0 async engine with Base model
- Set up Alembic for database migrations with async support
- Created health check endpoint and Swagger docs at /docs

## Files Created/Modified

- `apps/backend/pyproject.toml` - Python dependencies
- `apps/backend/main.py` - FastAPI app with /health endpoint
- `apps/backend/config.py` - Environment configuration
- `apps/backend/database.py` - SQLAlchemy async engine and session
- `apps/backend/models/base.py` - Base model with common columns
- `apps/backend/alembic.ini` - Alembic configuration
- `apps/backend/alembic/env.py` - Alembic async migrations

## Decisions Made

- Using SQLAlchemy 2.0 async (not sync) for better performance with I/O-bound operations
- Alembic for schema migrations (not raw SQL)
- Pydantic Settings for type-safe config management
- UUID primary keys for distributed system safety

## Issues Encountered

None (database connection will be established in Docker plan)

## Next Step

Ready for 01-04-PLAN.md (Docker Infrastructure)
</output>
