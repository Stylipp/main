---
phase: 01-foundation-infrastructure
plan: 05
type: execute
depends_on: ["01-03", "01-04"]
files_modified: [apps/backend/auth/router/router.py, apps/backend/auth/service/service.py, apps/backend/auth/schemas/schemas.py, apps/backend/auth/utils/jwt.py, apps/backend/models/user.py, secrets/jwt/private.pem, secrets/jwt/public.pem]
---

<objective>
Create JWT authentication scaffold with ES256 keypair generation and protected route example using feature folder convention.

Purpose: Establish authentication foundation for all protected API endpoints. ES256 (ECDSA) provides modern cryptographic security with smaller key sizes and faster verification than RSA. Volume-mounted keys ensure secure storage outside environment variables.
Output: Working JWT token generation/validation system with keypairs stored in Docker volume, example protected route demonstrating authentication flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md

**JWT algorithm**: ES256 (ECDSA with P-256 curve)
**Key storage**: Volume-mounted files in secrets/jwt/ (private.pem 600 permissions, public.pem 644)
**Token lifetime**: 15 days for MVP (adjust in production based on analytics)
**Feature folder pattern**: auth/router/router.py, auth/service/service.py, auth/schemas/schemas.py, auth/utils/jwt.py
**User model**: SQLAlchemy model with email, password_hash, created_at
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate ES256 keypair and configure Docker volume</name>
  <files>secrets/jwt/private.pem, secrets/jwt/public.pem, infra/docker-compose.yml</files>
  <action>
    Generate ES256 ECDSA keypair:
    `mkdir -p secrets/jwt`
    `openssl ecparam -genkey -name prime256v1 -noout -out secrets/jwt/private.pem`
    `openssl ec -in secrets/jwt/private.pem -pubout -out secrets/jwt/public.pem`

    Set proper permissions:
    `chmod 600 secrets/jwt/private.pem` (owner read/write only)
    `chmod 644 secrets/jwt/public.pem` (world-readable)

    Update infra/docker-compose.yml to add backend service (or update when added):
    - volumes: ./secrets/jwt:/app/secrets:ro (read-only mount)

    Add secrets/ to .gitignore to prevent committing keys:
    `echo "secrets/" >> .gitignore`

    For development, copy keys to apps/backend/secrets/jwt/ for local running:
    `mkdir -p apps/backend/secrets/jwt`
    `cp secrets/jwt/*.pem apps/backend/secrets/jwt/`
  </action>
  <verify>ls -l secrets/jwt/ shows private.pem (600) and public.pem (644), openssl ec -in secrets/jwt/private.pem -text -noout displays EC key parameters</verify>
  <done>ES256 keypair generated with proper permissions, Docker volume configured, keys excluded from git, development keys copied</done>
</task>

<task type="auto">
  <name>Task 2: Create auth feature with JWT utilities and User model</name>
  <files>apps/backend/auth/utils/jwt.py, apps/backend/auth/schemas/schemas.py, apps/backend/models/user.py</files>
  <action>
    Create apps/backend/auth/utils/jwt.py:
    - Import jwt from python-jose[cryptography]
    - Load private.pem and public.pem from secrets/jwt/ directory
    - Function create_access_token(user_id: UUID, expires_delta: timedelta = 15 days) -> str
      - Payload: {"sub": str(user_id), "exp": expire_timestamp, "iat": issued_at}
      - Algorithm: ES256
    - Function verify_token(token: str) -> UUID:
      - Decode with public key, algorithm ES256
      - Return user_id from "sub" claim
      - Raise HTTPException 401 if invalid/expired

    Create apps/backend/auth/schemas/schemas.py:
    - TokenResponse(BaseModel): access_token (str), token_type (str) = "bearer"
    - LoginRequest(BaseModel): email (EmailStr), password (str)
    - UserResponse(BaseModel): id (UUID), email (EmailStr), created_at (datetime)

    Create apps/backend/models/user.py:
    - User model extending Base from models/base.py
    - Columns: email (String, unique, index), password_hash (String)
    - Inherits id, created_at, updated_at from Base
  </action>
  <verify>Python imports resolve without errors, create_access_token() generates JWT token string, verify_token() decodes it successfully</verify>
  <done>JWT utility functions created with ES256 algorithm, auth schemas defined, User model created with email and password_hash</done>
</task>

<task type="auto">
  <name>Task 3: Implement auth router with protected route example</name>
  <files>apps/backend/auth/router/router.py, apps/backend/auth/service/service.py, apps/backend/main.py, apps/backend/dependencies.py</files>
  <action>
    Create apps/backend/dependencies.py:
    - Function get_current_user(token: str = Depends(OAuth2PasswordBearer(tokenUrl="/api/auth/login"))) -> UUID
      - Calls verify_token(token) from auth/utils/jwt.py
      - Returns user_id
      - Used as dependency for protected routes

    Create apps/backend/auth/service/service.py:
    - Placeholder authenticate_user(email: str, password: str) -> User | None
      - Will implement full logic in later phase
      - For now, return None (authentication not yet functional)

    Create apps/backend/auth/router/router.py:
    - APIRouter with prefix="/auth", tags=["Authentication"]
    - POST /login endpoint (placeholder, returns 501 Not Implemented for now)
    - GET /me endpoint (protected): Depends(get_current_user), returns current user info

    Update apps/backend/main.py:
    - Import auth router
    - app.include_router(auth_router, prefix="/api")
    - Example protected route: GET /api/auth/me requires valid JWT

    Create empty __init__.py files in auth/, auth/router/, auth/service/, auth/schemas/, auth/utils/
  </action>
  <verify>curl http://localhost:8000/api/auth/me without token returns 401, /docs shows /api/auth/login and /api/auth/me endpoints</verify>
  <done>Auth router created with protected /me endpoint, get_current_user dependency implemented, feature folder structure follows convention (auth/router/router.py pattern)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ES256 keypair exists in secrets/jwt/ with correct permissions
- [ ] secrets/ directory in .gitignore
- [ ] JWT utility functions (create_access_token, verify_token) work
- [ ] User model defined in database models
- [ ] GET /api/auth/me endpoint requires authentication (returns 401 without token)
- [ ] /docs shows authentication endpoints
- [ ] Feature folder structure follows convention (auth/router/router.py, auth/service/service.py)
- [ ] FastAPI server starts without errors
</verification>

<success_criteria>

- ES256 keypair generated and secured with proper permissions
- JWT token creation and verification utilities implemented
- User model created in database schema
- Protected route example demonstrates authentication flow
- Feature folder convention established (router/, service/, schemas/, utils/)
- Authentication middleware ready for future login implementation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-05-SUMMARY.md`:

# Phase 1 Plan 5: JWT Authentication Scaffold Summary

**Created JWT authentication system with ES256 keypairs and protected route example following feature folder convention**

## Accomplishments

- Generated ES256 ECDSA keypair for JWT signing and verification
- Configured volume-mounted key storage with proper permissions
- Implemented JWT utility functions (create_access_token, verify_token)
- Created User model with email and password_hash columns
- Built auth feature with router, service, schemas, utils structure
- Added protected route example (/api/auth/me)

## Files Created/Modified

- `secrets/jwt/private.pem` - ECDSA private key (600 permissions)
- `secrets/jwt/public.pem` - ECDSA public key (644 permissions)
- `apps/backend/auth/router/router.py` - Auth API routes
- `apps/backend/auth/service/service.py` - Auth business logic
- `apps/backend/auth/schemas/schemas.py` - Auth request/response schemas
- `apps/backend/auth/utils/jwt.py` - JWT token utilities
- `apps/backend/models/user.py` - User database model
- `apps/backend/dependencies.py` - get_current_user dependency
- Updated `apps/backend/main.py` - Include auth router

## Decisions Made

- ES256 (ECDSA P-256) over RS256 for smaller keys and faster verification
- Volume-mounted keys over environment variables for better security
- 15-day token lifetime for MVP (adjustable based on user behavior analytics)
- Feature folder convention with subfolders (auth/router/router.py pattern)
- OAuth2PasswordBearer for standards-compliant token authentication

## Issues Encountered

None

## Next Step

Ready for 01-06-PLAN.md (Object Storage Configuration)
</output>
