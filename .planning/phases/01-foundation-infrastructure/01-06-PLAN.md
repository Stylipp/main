---
phase: 01-foundation-infrastructure
plan: 06
type: execute
depends_on: ["01-03"]
files_modified: [apps/backend/storage/service/service.py, apps/backend/storage/schemas/schemas.py, apps/backend/config.py, apps/backend/.env.example]
---

<objective>
Configure Hetzner Object Storage (S3-compatible) client with upload/download utilities for user photos and product images.

Purpose: Establish object storage layer for all image assets (user outfit photos during onboarding, product images). S3-compatible interface allows future migration to AWS/MinIO if needed without code changes.
Output: Working storage service with upload/download capabilities, connection tested, ready for user photo uploads in onboarding phase.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md

**Provider**: Hetzner Object Storage (S3-compatible)
**Endpoint**: hel1.your-objectstorage.com
**Bucket**: station11-bucket
**Access Key**: U7XNPO7JDQGLAV8YY8KW
**Secret Key**: 94Oq4B76PMa880YyeJclSYLgsGpxMsdKohm9FFxX
**Use cases**: User outfit photos (onboarding), product images (ingestion), cached thumbnails
**Library**: boto3 (standard S3 client for Python)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure S3 client for Hetzner Object Storage</name>
  <files>apps/backend/config.py, apps/backend/.env.example</files>
  <action>
    Update apps/backend/config.py to add object storage configuration:
    - S3_ENDPOINT_URL: str = "https://hel1.your-objectstorage.com"
    - S3_ACCESS_KEY: str
    - S3_SECRET_KEY: str
    - S3_BUCKET_NAME: str = "station11-bucket"
    - S3_REGION: str = "hel1" (Hetzner region)

    Update apps/backend/.env.example:
    - S3_ENDPOINT_URL=https://hel1.your-objectstorage.com
    - S3_ACCESS_KEY=U7XNPO7JDQGLAV8YY8KW
    - S3_SECRET_KEY=94Oq4B76PMa880YyeJclSYLgsGpxMsdKohm9FFxX
    - S3_BUCKET_NAME=station11-bucket
    - S3_REGION=hel1

    Add boto3 to apps/backend/pyproject.toml dependencies:
    - boto3 ~=1.34

    Install: `cd apps/backend && pip install boto3`
  </action>
  <verify>apps/backend/config.py has S3_* configuration fields, .env.example contains Hetzner credentials</verify>
  <done>S3 configuration added to settings, Hetzner credentials in .env.example, boto3 installed</done>
</task>

<task type="auto">
  <name>Task 2: Create storage service layer with upload/download utilities</name>
  <files>apps/backend/storage/service/service.py, apps/backend/storage/__init__.py</files>
  <action>
    Create apps/backend/storage/service/service.py:

    - Import boto3, botocore
    - Class S3StorageService:
      - __init__: Initialize boto3 client with config.S3_ENDPOINT_URL, access_key, secret_key, region
      - async upload_file(file: UploadFile, key: str, content_type: str = None) -> str:
        - Upload file to S3 bucket with key
        - Use put_object() with file bytes
        - Return public URL: f"{S3_ENDPOINT_URL}/{S3_BUCKET_NAME}/{key}"
      - async download_file(key: str) -> bytes:
        - Download file from S3 by key
        - Return file bytes
      - async delete_file(key: str) -> bool:
        - Delete file from S3 by key
        - Return success status
      - async file_exists(key: str) -> bool:
        - Check if file exists using head_object()
        - Return True if exists, False otherwise

    Add docstrings explaining usage patterns:
    - User photos: "user_photos/{user_id}/{uuid}.jpg"
    - Product images: "products/{product_id}/{uuid}.jpg"

    Create __init__.py files in storage/, storage/service/
  </action>
  <verify>No syntax errors in storage/service/service.py, boto3 imports resolve correctly</verify>
  <done>S3StorageService class created with upload/download/delete/exists methods, async interface for FastAPI integration</done>
</task>

<task type="auto">
  <name>Task 3: Add storage schemas and connection test endpoint</name>
  <files>apps/backend/storage/schemas/schemas.py, apps/backend/storage/router/router.py, apps/backend/main.py</files>
  <action>
    Create apps/backend/storage/schemas/schemas.py:
    - UploadResponse(BaseModel): url (HttpUrl), key (str), size (int)

    Create apps/backend/storage/router/router.py:
    - APIRouter with prefix="/storage", tags=["Storage"]
    - GET /health endpoint to test S3 connection:
      - Call boto3 head_bucket() on station11-bucket
      - Return {"status": "connected", "bucket": "station11-bucket"} if success
      - Return 503 Service Unavailable if connection fails

    Update apps/backend/main.py:
    - Import storage router
    - app.include_router(storage_router, prefix="/api")

    Test connection: Visit /api/storage/health to verify Hetzner credentials work

    Create __init__.py in storage/router/, storage/schemas/
  </action>
  <verify>GET /api/storage/health returns {"status": "connected", "bucket": "station11-bucket"} with 200 status</verify>
  <done>Storage schemas defined, health check endpoint confirms S3 connection, storage router integrated into main app</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] apps/backend/config.py has S3_ENDPOINT_URL and credentials config
- [ ] boto3 installed and imports successfully
- [ ] S3StorageService class has upload/download/delete/exists methods
- [ ] GET /api/storage/health returns 200 with "connected" status
- [ ] Connection to station11-bucket succeeds
- [ ] /docs shows /api/storage/health endpoint
</verification>

<success_criteria>

- Hetzner Object Storage configured with valid credentials
- S3StorageService implemented with async methods
- Connection test endpoint confirms bucket access
- Upload/download utilities ready for user photos and product images
- S3-compatible interface allows future provider migration
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-06-SUMMARY.md`:

# Phase 1 Plan 6: Object Storage Configuration Summary

**Configured Hetzner Object Storage with S3-compatible client and upload/download utilities**

## Accomplishments

- Configured boto3 S3 client for Hetzner Object Storage
- Created S3StorageService with upload, download, delete, exists methods
- Added storage health check endpoint to verify connection
- Defined storage schemas for upload responses
- Tested connection to station11-bucket successfully

## Files Created/Modified

- `apps/backend/config.py` - Added S3_* configuration fields
- `apps/backend/.env.example` - Added Hetzner credentials
- `apps/backend/storage/service/service.py` - S3StorageService class
- `apps/backend/storage/schemas/schemas.py` - Upload response schema
- `apps/backend/storage/router/router.py` - Health check endpoint
- Updated `apps/backend/main.py` - Include storage router

## Decisions Made

- Using boto3 for S3-compatible interface (allows provider migration)
- Async methods for FastAPI integration
- Key pattern: user_photos/{user_id}/{uuid}.jpg, products/{product_id}/{uuid}.jpg
- Health check endpoint for monitoring storage connectivity

## Issues Encountered

None

## Next Step

Ready for 01-07-PLAN.md (Traefik Configuration)
</output>
