---
phase: 01-foundation-infrastructure
plan: 06
type: execute
depends_on: ["01-03"]
files_modified: [apps/backend/src/features/storage/service/service.py, apps/backend/src/features/storage/schemas/schemas.py, apps/backend/src/core/config.py, apps/backend/src/core/__init__.py, apps/backend/.env.example, apps/backend/src/features/storage/router/router.py]
---

<objective>
Configure Hetzner Object Storage (S3-compatible) client with upload/download utilities for user photos and product images.

Purpose: Establish object storage layer for all image assets (user outfit photos during onboarding, product images). S3-compatible interface allows future migration to AWS/MinIO if needed without code changes.
Output: Working storage service with upload/download capabilities, connection tested, ready for user photo uploads in onboarding phase.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md

**Provider**: Hetzner Object Storage (S3-compatible)
**Endpoint**: https://hel1.your-objectstorage.com
**Bucket**: station11-bucket
**Credentials**: User will provide via .env file (not in version control)
**Use cases**: User outfit photos (onboarding), product images (ingestion), cached thumbnails
**Library**: aioboto3 (async S3 client for Python, not sync boto3)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure S3 client for Hetzner Object Storage</name>
  <files>apps/backend/src/core/config.py, apps/backend/src/core/__init__.py, apps/backend/.env.example</files>
  <action>
    Update apps/backend/src/core/config.py to add object storage configuration:
    - S3_ENDPOINT_URL: str = "https://hel1.your-objectstorage.com"
    - S3_ACCESS_KEY: str
    - S3_SECRET_KEY: str
    - S3_BUCKET_NAME: str = "station11-bucket"
    - S3_REGION: str = "hel1" (Hetzner region)

    Update apps/backend/.env.example with PLACEHOLDER credentials (user fills in real values):
    - S3_ENDPOINT_URL=https://hel1.your-objectstorage.com
    - S3_ACCESS_KEY=YOUR_HETZNER_ACCESS_KEY
    - S3_SECRET_KEY=YOUR_HETZNER_SECRET_KEY
    - S3_BUCKET_NAME=station11-bucket
    - S3_REGION=hel1

    Add aioboto3 to apps/backend/pyproject.toml dependencies (not boto3 - need async):
    - aioboto3 ~=13.0

    Install: `cd apps/backend && pip install aioboto3`
  </action>
  <verify>apps/backend/src/core/config.py has S3_* configuration fields, .env.example contains PLACEHOLDER credentials (not real ones)</verify>
  <done>S3 configuration added to settings, .env.example has placeholders for user to fill, aioboto3 installed for true async</done>
</task>

<task type="auto">
  <name>Task 2: Create storage service layer with upload/download utilities</name>
  <files>apps/backend/src/features/storage/service/service.py, apps/backend/src/features/storage/__init__.py</files>
  <action>
    Create apps/backend/src/features/storage/service/service.py:

    - Import aioboto3, botocore (aioboto3 provides true async, not boto3)
    - Class S3StorageService:
      - __init__: Store config (endpoint, access_key, secret_key, bucket, region)
      - async upload_file(file: UploadFile, key: str, content_type: str = None) -> str:
        - Use aioboto3 session and async with client('s3') context manager
        - Upload file to S3 bucket with await client.put_object()
        - Return public URL: f"{S3_ENDPOINT_URL}/{S3_BUCKET_NAME}/{key}"
      - async download_file(key: str) -> bytes:
        - Use aioboto3 async client to download file from S3
        - Return file bytes
      - async delete_file(key: str) -> bool:
        - Use aioboto3 async client to delete file from S3
        - Return success status
      - async file_exists(key: str) -> bool:
        - Use aioboto3 async client to check if file exists with head_object()
        - Return True if exists, False otherwise

    Add docstrings explaining usage patterns:
    - User photos: "user_photos/{user_id}/{uuid}.jpg"
    - Product images: "products/{product_id}/{uuid}.jpg"

    Create __init__.py files in src/features/storage/, src/features/storage/service/
  </action>
  <verify>No syntax errors in src/features/storage/service/service.py, aioboto3 imports resolve correctly</verify>
  <done>S3StorageService class created with aioboto3 for true async upload/download/delete/exists methods</done>
</task>

<task type="auto">
  <name>Task 3: Add storage schemas and connection test endpoint</name>
  <files>apps/backend/src/features/storage/schemas/schemas.py, apps/backend/src/features/storage/router/router.py, apps/backend/src/main.py</files>
  <action>
    Create apps/backend/src/features/storage/schemas/schemas.py:
    - UploadResponse(BaseModel): url (HttpUrl), key (str), size (int)

    Create apps/backend/src/features/storage/router/router.py:
    - APIRouter with prefix="/storage", tags=["Storage"]
    - GET /health endpoint to test S3 connection:
      - Use aioboto3 async client to call head_bucket() on station11-bucket
      - Return {"status": "connected", "bucket": "station11-bucket"} if success
      - Return 503 Service Unavailable if connection fails

    Update apps/backend/src/main.py:
    - Import storage router from src.features.storage.router.router
    - app.include_router(storage_router, prefix="/api")

    Test connection: Visit /api/storage/health to verify Hetzner credentials work

    Create __init__.py in src/features/storage/router/, src/features/storage/schemas/
  </action>
  <verify>GET /api/storage/health returns {"status": "connected", "bucket": "station11-bucket"} with 200 status once real credentials are set</verify>
  <done>Storage schemas defined in src/, health check endpoint uses aioboto3 async, storage router integrated into main app</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] apps/backend/src/core/config.py has S3_ENDPOINT_URL and credentials config
- [ ] apps/backend/.env.example has PLACEHOLDER credentials (not real ones)
- [ ] aioboto3 installed and imports successfully
- [ ] S3StorageService class has async upload/download/delete/exists methods using aioboto3
- [ ] GET /api/storage/health returns 200 with "connected" status
- [ ] Connection to station11-bucket succeeds
- [ ] /docs shows /api/storage/health endpoint
</verification>

<success_criteria>

- Hetzner Object Storage configured with PLACEHOLDER credentials in .env.example
- S3StorageService implemented with aioboto3 for true async (not blocking boto3)
- Connection test endpoint confirms bucket access
- Upload/download utilities ready for user photos and product images
- S3-compatible interface allows future provider migration
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-06-SUMMARY.md`:

# Phase 1 Plan 6: Object Storage Configuration Summary

**Configured Hetzner Object Storage with async S3-compatible client and upload/download utilities**

## Accomplishments

- Configured aioboto3 S3 client for Hetzner Object Storage
- Created S3StorageService with upload, download, delete, exists methods
- Added storage health check endpoint to verify connection
- Defined storage schemas for upload responses
- Added health check endpoint for bucket connectivity (requires real credentials to pass)

## Files Created/Modified

- `apps/backend/src/core/config.py` - Added S3_* configuration fields
- `apps/backend/.env.example` - Added Hetzner placeholder credentials
- `apps/backend/src/features/storage/service/service.py` - S3StorageService class
- `apps/backend/src/features/storage/schemas/schemas.py` - Upload response schema
- `apps/backend/src/features/storage/router/router.py` - Health check endpoint
- Updated `apps/backend/src/main.py` - Include storage router

## Decisions Made

- Using aioboto3 for true async S3-compatible interface (allows provider migration)
- Async methods for FastAPI integration
- Key pattern: user_photos/{user_id}/{uuid}.jpg, products/{product_id}/{uuid}.jpg
- Health check endpoint for monitoring storage connectivity

## Issues Encountered

None

## Next Step

Ready for 01-07-PLAN.md (Traefik Configuration)
</output>
